name: Ephemeral PR Environments

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

# 1. CONCURRENCY: Prevent Terraform state locks and save money on rapid pushes
concurrency:
  group: pr-env-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 123456789012.dkr.ecr.us-east-1.amazonaws.com # Replace with your AWS Account ID
  PR_NUMBER: ${{ github.event.pull_request.number }}
  FRONTEND_URL: pr-${{ github.event.pull_request.number }}.app.yourdomain.com
  BACKEND_URL: https://pr-${{ github.event.pull_request.number }}.api.yourdomain.com

permissions:
  contents: read
  pull-requests: write

jobs:
  # =========================================================
  # JOB 1: CREATE OR UPDATE THE PREVIEW ENVIRONMENT
  # =========================================================
  deploy-preview:
    name: Deploy PR Environment
    if: github.event.action != 'closed'
    runs-on: [self-hosted, linux, x64, saas-ci]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Backend Image
        working-directory: ./backend
        run: |
          IMAGE_TAG=pr-${{ env.PR_NUMBER }}
          docker build -t ${{ env.ECR_REGISTRY }}/saas-backend:$IMAGE_TAG .
          docker push ${{ env.ECR_REGISTRY }}/saas-backend:$IMAGE_TAG

      - name: Build & Push Frontend Image
        working-directory: ./frontend
        run: |
          IMAGE_TAG=pr-${{ env.PR_NUMBER }}
          docker build \
            --build-arg VITE_API_URL=${{ env.BACKEND_URL }} \
            -t ${{ env.ECR_REGISTRY }}/saas-frontend:$IMAGE_TAG .
          docker push ${{ env.ECR_REGISTRY }}/saas-frontend:$IMAGE_TAG

      - name: Apply Terraform Infrastructure
        working-directory: ./infrastructure/pr-environments
        run: |
          terraform init

          terraform workspace select pr-${{ env.PR_NUMBER }} || terraform workspace new pr-${{ env.PR_NUMBER }}

          terraform apply -auto-approve \
            -var="pr_number=${{ env.PR_NUMBER }}" \
            -var="image_tag=pr-${{ env.PR_NUMBER }}" \
            -var="frontend_host=${{ env.FRONTEND_URL }}" \
            -var="backend_host=${{ env.BACKEND_URL }}"

      # 2. COMMENT SPAM PREVENTION: Only comment on new PRs, don't spam on 'synchronize' (pushes)
      - name: Comment PR with Preview Links
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ **Preview Environment Successfully Deployed!**\n\nüíª **Frontend UI:** https://${process.env.FRONTEND_URL}\nüîå **Backend API:** ${process.env.BACKEND_URL}\n\n_This environment is isolated and connected to the staging database. It will automatically update when you push new commits, and will be destroyed when this PR is closed._`
            })

  # =========================================================
  # JOB 2: DESTROY THE ENVIRONMENT (COST SAVINGS)
  # =========================================================
  destroy-preview:
    name: Destroy PR Environment
    if: github.event.action == 'closed'
    # Ensure this runs even if the deployment was cancelled midway through
    runs-on: [self-hosted, linux, x64, saas-ci]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 3. GRACEFUL TEARDOWN: Prevent failure if the workspace was never created
      - name: Destroy Terraform Infrastructure
        working-directory: ./infrastructure/pr-environments
        run: |
          terraform init

          # Check if the workspace actually exists before trying to destroy it
          if terraform workspace select pr-${{ env.PR_NUMBER }}; then
            terraform destroy -auto-approve \
              -var="pr_number=${{ env.PR_NUMBER }}" \
              -var="image_tag=pr-${{ env.PR_NUMBER }}" \
              -var="frontend_host=${{ env.FRONTEND_URL }}" \
              -var="backend_host=${{ env.BACKEND_URL }}"
              
            terraform workspace select default
            terraform workspace delete pr-${{ env.PR_NUMBER }}
          else
            echo "Workspace pr-${{ env.PR_NUMBER }} does not exist. Nothing to destroy."
          fi

      - name: Comment PR - Environment Destroyed
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üóëÔ∏è **Preview Environment Destroyed.**\n\nThe temporary AWS infrastructure for this PR has been cleanly removed to save costs.`
            })
