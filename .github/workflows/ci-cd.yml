name: Full Stack CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# 1. CONCURRENCY: Cancel older, redundant runs to save EC2 Spot instance costs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# 2. PERMISSIONS: Enforce least privilege for the GitHub token
permissions:
  contents: read

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 569758639273.dkr.ecr.us-east-1.amazonaws.com
  PROD_API_URL: https://api.rwako.com

jobs:
  # =========================================================
  # JOB 1: BACKEND CI (Lint, Test, & TypeScript Build)
  # =========================================================
  backend-ci:
    name: Backend CI
    runs-on: [self-hosted, linux, x64, saas-ci]
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 3. NODE 22: Upgraded to modern LTS standard
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: './backend/package-lock.json'

      - name: Install Dependencies
        run: npm ci

      - name: Enforce Code Formatting (Prettier)
        run: npx prettier --check "**/*.ts"

      - name: TypeScript Type Check
        run: npx tsc --noEmit

      - name: Run Unit Tests
        run: npm run test --if-present

  # =========================================================
  # JOB 2: FRONTEND CI (Lint, Test, & Vite Build)
  # =========================================================
  frontend-ci:
    name: Frontend CI
    runs-on: [self-hosted, linux, x64, saas-ci]
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install Dependencies
        run: npm ci

      - name: Enforce Code Formatting (Prettier)
        run: npx prettier --check "**/*.{ts,tsx}"

      - name: Build Vite App
        run: npm run build

  # =========================================================
  # JOB 3: DEPLOY TO AWS (Migrate DB, Build Images, Update ECS)
  # =========================================================
  deploy-to-aws:
    name: Deploy to Production
    needs: [backend-ci, frontend-ci]
    # Only run deployment if the code is merged/pushed to main
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: [self-hosted, linux, x64, saas-ci]

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: './backend/package-lock.json'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::569758639273:role/saas-github-actions-deploy-role
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Install AWS CLI
        run: |
          if ! command -v aws &> /dev/null; then
            echo "AWS CLI not found, installing..."
            sudo apt-get update && sudo apt-get install -y unzip
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install --update
            rm -rf awscliv2.zip aws/
          else
            echo "AWS CLI is already installed"
          fi

      # 4. DATABASE MIGRATIONS: Run safely inside the VPC before deploying new code
      - name: Run Database Migrations
        working-directory: ./backend
        run: |
          # Fetch the production database URL from SSM Parameter Store dynamically
          DATABASE_URL=$(aws ssm get-parameter --name "/saas/production/database/url" --with-decryption --query "Parameter.Value" --output text)

          if [ -z "$DATABASE_URL" ]; then
            echo "Error: Failed to fetch DATABASE_URL from SSM"
            exit 1
          fi

          export DATABASE_URL=$DATABASE_URL

          # Debug: Show the hostname being used (masking password)
          echo "Connecting to: $(echo $DATABASE_URL | sed 's/:.*@/:****@/')"

          npm ci
          npm run migrate

      - name: Build and Push Backend Image
        working-directory: ./backend
        run: |
          IMAGE_TAG=${{ github.sha }}
          REPOSITORY=saas-backend

          docker build --platform linux/amd64 -t $ECR_REGISTRY/$REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$REPOSITORY:$IMAGE_TAG

          # Tag as latest for easy reference
          docker tag $ECR_REGISTRY/$REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$REPOSITORY:latest
          docker push $ECR_REGISTRY/$REPOSITORY:latest

      # 5. FRONTEND BUILD ENV: Inject the production API URL during Docker build
      - name: Build and Push Frontend Image
        working-directory: ./frontend
        run: |
          IMAGE_TAG=${{ github.sha }}
          REPOSITORY=saas-frontend

          docker build \
            --platform linux/amd64 \
            --build-arg VITE_API_URL=${{ env.PROD_API_URL }} \
            -t $ECR_REGISTRY/$REPOSITORY:$IMAGE_TAG .
            
          docker push $ECR_REGISTRY/$REPOSITORY:$IMAGE_TAG

          # Tag as latest for ECS
          docker tag $ECR_REGISTRY/$REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$REPOSITORY:latest
          docker push $ECR_REGISTRY/$REPOSITORY:latest

      - name: Install Kubectl and Kustomize
        run: |
          if ! command -v kubectl &> /dev/null; then
            echo "Kubectl not found, installing..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
            rm kubectl
          fi

          if ! command -v kustomize &> /dev/null; then
            echo "Kustomize not found, installing..."
            curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
            sudo mv kustomize /usr/local/bin/
          fi

          # 1. Update kubeconfig to connect to the new cluster
          aws eks update-kubeconfig --name saas-production-cluster --region us-east-1

          # 2. Apply all Kubernetes manifests (Deployments, Services, Ingress)
          kubectl apply -f ../kubernetes/

          # 3. Trigger a rolling restart to ensure the new images are pulled
          kubectl rollout restart deployment saas-backend
          kubectl rollout restart deployment saas-frontend
